{# templates/application/index.html.twig #}

{% extends 'base.html.twig' %}

{% block title %}
    {% if is_granted('ROLE_RECRUITER') %}
        Applications - HireFlow
    {% else %}
        My Applications - HireFlowa
    {% endif %}
{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .action-btn {
        padding: 5px 12px;
        font-size: 0.85rem;
        border-radius: 4px;
        margin: 2px;
    }
    .cover-letter-preview {
        max-height: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }
    .modal-lg-custom {
        max-width: 900px;
    }
    .file-download-btn {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 8px 15px;
        border-radius: 4px;
        text-decoration: none;
        color: #495057;
        display: inline-flex;
        align-items: center;
        transition: all 0.2s;
    }
    .file-download-btn:hover {
        background: #e9ecef;
        color: #212529;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                {% if is_granted('ROLE_RECRUITER') %}
                    Applications
                {% else %}
                    My Applications
                {% endif %}
            </h1>
            <p class="text-muted mb-0">
                {% if is_granted('ROLE_RECRUITER') %}
                    Manage applications for your job offers
                {% else %}
                    Track your job applications
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statsCards">
        <!-- Stats will be loaded via JavaScript -->
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput"
                                   placeholder="Search by candidate name, email, or cover letter...">
                        </div>

                        {% if is_granted('ROLE_RECRUITER') %}
                        <div class="col-md-3">
                            <select class="form-select" id="offerFilter">
                                <option value="">All Offers</option>
                                {% for offer in offers %}
                                    <option value="{{ offer.id }}">{{ offer.title }} ({{ offer.applications|length }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="PENDING">Pending</option>
                                <option value="ACCEPTED">Accepted</option>
                                <option value="REJECTED">Rejected</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary w-100" onclick="performSearch()">
                                    <i class="bi bi-search"></i> Search
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearSearch()">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        {% if is_granted('ROLE_RECRUITER') %}
                            <th>Candidate</th>
                            <th>Email</th>
                        {% endif %}
                        <th>Job Offer</th>
                        <th>Cover Letter</th>
                        <th>Resume</th>
                        <th>Status</th>
                        <th>Applied Date</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="applicationsTableBody">
                    {% for application in applications %}
                    <tr id="application-{{ application.id }}">
                        {% if is_granted('ROLE_RECRUITER') %}
                            <td class="fw-semibold">{{ application.candidate.fullName }}</td>
                            <td>{{ application.candidate.email }}</td>
                        {% endif %}
                        <td>
                            <div class="fw-semibold">{{ application.offer.title }}</div>
                            <small class="text-muted">{{ application.offer.location|default('Remote') }}</small>
                        </td>
                        <td>
                            <div class="cover-letter-preview">
                                {{ application.coverLetter|slice(0, 100) }}...
                            </div>
                        </td>
                        <td>
                            {% if application.resume %}
                                <a href="{{ path('application_show', {'id': application.id}) }}"
                                   class="file-download-btn"
                                   onclick="event.preventDefault(); showApplicationDetails({{ application.id }})">
                                    <i class="bi bi-file-earmark-pdf me-2"></i>View CV
                                </a>
                            {% else %}
                                <span class="text-muted">No CV</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge {{ application.getStatusBadgeClass() }}">
                                {{ application.getStatusText() }}
                            </span>
                        </td>
                        <td>{{ application.createdAt|date('M d, Y') }}</td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <!-- View Details Button (for both roles) -->
                                <button type="button" class="btn btn-outline-info action-btn"
                                        onclick="showApplicationDetails({{ application.id }})"
                                        title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>

                                {% if is_granted('ROLE_CANDIDATE') %}
                                    <!-- Edit Button (only for pending applications) -->
                                    {% if application.getStatus() == 'PENDING' %}
                                        <button type="button" class="btn btn-outline-primary action-btn"
                                                onclick="showEditApplicationModal({{ application.id }})"
                                                title="Edit Application">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    {% endif %}

                                    <!-- Delete Button (only for pending applications) -->
                                    {% if application.getStatus() == 'PENDING' %}
                                        <button type="button" class="btn btn-outline-danger action-btn"
                                                onclick="deleteApplication({{ application.id }})"
                                                title="Delete Application">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    {% endif %}
                                {% endif %}

                                {% if is_granted('ROLE_RECRUITER') %}
                                    <!-- Accept Button -->
                                    <button type="button" class="btn btn-outline-success action-btn"
                                            onclick="updateApplicationStatus({{ application.id }}, 'ACCEPTED')"
                                            title="Accept Application"
                                            {% if application.getStatus() == 'ACCEPTED' %}disabled{% endif %}>
                                        <i class="bi bi-check-circle"></i>
                                    </button>

                                    <!-- Reject Button -->
                                    <button type="button" class="btn btn-outline-danger action-btn"
                                            onclick="updateApplicationStatus({{ application.id }}, 'REJECTED')"
                                            title="Reject Application"
                                            {% if application.getStatus() == 'REJECTED' %}disabled{% endif %}>
                                        <i class="bi bi-x-circle"></i>
                                    </button>

                                    <!-- Reset Button (if accepted or rejected) -->
                                    {% if application.getStatus() in ['ACCEPTED', 'REJECTED'] %}
                                        <button type="button" class="btn btn-outline-warning action-btn"
                                                onclick="updateApplicationStatus({{ application.id }}, 'PENDING')"
                                                title="Reset to Pending">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="{% if is_granted('ROLE_RECRUITER') %}8{% else %}6{% endif %}" class="text-center py-5">
                            <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: #dee2e6;"></i>
                            <h5 class="text-muted mt-3">No applications found</h5>
                            {% if is_granted('ROLE_RECRUITER') %}
                                <p class="text-muted">Applications will appear here when candidates apply to your offers</p>
                            {% else %}
                                <p class="text-muted">You haven't applied to any job offers yet</p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div id="paginationContainer" class="mt-4"></div>
</div>

<!-- VIEW APPLICATION MODAL -->
<div class="modal fade" id="viewApplicationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-lg-custom">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewApplicationTitle">Application Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <span class="badge" id="viewApplicationStatus"></span>
                            <span class="badge bg-secondary">
                                <i class="bi bi-calendar me-1"></i><span id="viewApplicationDate"></span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="mb-2">Candidate Information</h6>
                        <div class="card">
                            <div class="card-body">
                                <p class="mb-1"><strong>Name:</strong> <span id="viewCandidateName"></span></p>
                                <p class="mb-1"><strong>Email:</strong> <span id="viewCandidateEmail"></span></p>
                                <p class="mb-0"><strong>Phone:</strong> <span id="viewCandidatePhone"></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-2">Job Offer</h6>
                        <div class="card">
                            <div class="card-body">
                                <p class="mb-1"><strong>Position:</strong> <span id="viewOfferTitle"></span></p>
                                <p class="mb-0">
                                    <strong>Application ID:</strong> <span id="viewApplicationId"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="mb-2">Cover Letter</h6>
                        <div class="bg-light p-3 rounded" style="white-space: pre-wrap; line-height: 1.6;" id="viewCoverLetter"></div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="mb-2">Resume / CV</h6>
                        <div class="alert alert-info" id="viewResumeInfo">
                            <i class="bi bi-info-circle me-2"></i>
                            <span id="viewResumeText">No resume attached</span>
                        </div>
                        <a href="#" class="btn btn-primary" id="viewResumeLink" target="_blank" style="display: none;">
                            <i class="bi bi-download me-2"></i>Download Resume
                        </a>
                    </div>
                </div>

                {% if is_granted('ROLE_RECRUITER') %}
                <div class="row">
                    <div class="col-12">
                        <h6 class="mb-2">Quick Actions</h6>
                        <div class="d-flex gap-2" id="quickActions">
                            <!-- Actions will be populated dynamically -->
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- EDIT APPLICATION MODAL -->
<div class="modal fade" id="editApplicationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-lg-custom">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editApplicationForm">
                    <input type="hidden" id="editApplicationId">

                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>Job Offer</h6>
                            <p class="fw-semibold" id="editApplicationOfferTitle"></p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editCoverLetter" class="form-label">Cover Letter *</label>
                            <textarea class="form-control" id="editCoverLetter" rows="5" required></textarea>
                            <div class="invalid-feedback" id="editCoverLetterError"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editResumeFile" class="form-label">Resume / CV</label>
                            <input type="file" class="form-control" id="editResumeFile" accept=".pdf,.doc,.docx,.txt">
                            <small class="form-text text-muted">
                                Leave empty to keep current file. Allowed: PDF, DOC, DOCX, TXT (Max 5MB)
                            </small>
                            <div class="invalid-feedback" id="editResumeFileError"></div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                You can only edit pending applications. Once accepted or rejected, applications cannot be modified.
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateApplication()">
                    <i class="bi bi-check-circle me-2"></i>Update Application
                </button>
            </div>
        </div>
    </div>
</div>

<!-- DELETE CONFIRMATION MODAL -->
<div class="modal fade" id="deleteApplicationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Delete Application
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this application?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-octagon me-2"></i>
                    <strong>This action cannot be undone.</strong> The application will be permanently deleted.
                </div>
                <p class="mb-0">This will remove:</p>
                <ul>
                    <li>Your cover letter</li>
                    <li>Your resume/CV file</li>
                    <li>Application history</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteApplication()">
                    <i class="bi bi-trash me-2"></i>Delete Application
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts_body %}
<script>
// Load stats on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    createToastContainer();
});

// Load statistics
function loadStats() {
    fetch('/applications/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderStatsCards(data.stats);
            }
        });
}

function renderStatsCards(stats) {
    const container = document.getElementById('statsCards');

    if (!container) return;

    let cardsHtml = '';

    if (isRecruiter()) {
        cardsHtml = `
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Total Applications</h6>
                                <h4 class="mb-0">${stats.total || 0}</h4>
                            </div>
                            <div class="flex-shrink-0">
                                <i class="bi bi-files text-primary" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Pending</h6>
                                <h4 class="mb-0">${stats.pending || 0}</h4>
                            </div>
                            <div class="flex-shrink-0">
                                <i class="bi bi-clock text-warning" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Accepted</h6>
                                <h4 class="mb-0">${stats.accepted || 0}</h4>
                            </div>
                            <div class="flex-shrink-0">
                                <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Rejected</h6>
                                <h4 class="mb-0">${stats.rejected || 0}</h4>
                            </div>
                            <div class="flex-shrink-0">
                                <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        cardsHtml = `
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Applied Jobs</h6>
                                <h4 class="mb-0">${stats.total || 0}</h4>
                            </div>
                            <div class="flex-shrink-0">
                                <i class="bi bi-briefcase text-primary" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Pending</h6>
                                <h4 class="mb-0">${stats.pending || 0}</h4>
                            </div>
                            <div class="flex-shrink-0">
                                <i class="bi bi-clock text-warning" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Accepted</h6>
                                <h4 class="mb-0">${stats.accepted || 0}</h4>
                            </div>
                            <div class="flex-shrink-0">
                                <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Rejected</h6>
                                <h4 class="mb-0">${stats.rejected || 0}</h4>
                            </div>
                            <div class="flex-shrink-0">
                                <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    container.innerHTML = cardsHtml;
}

// Search functions
function performSearch() {
    const searchTerm = document.getElementById('searchInput').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const offerFilter = document.getElementById('offerFilter') ? document.getElementById('offerFilter').value : '';

    let url = `/applications/search?q=${encodeURIComponent(searchTerm)}&status=${encodeURIComponent(statusFilter)}`;
    if (offerFilter) {
        url += `&offer=${offerFilter}`;
    }

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTableWithSearchResults(data.applications);
                updatePagination(data.pagination.totalPages, data.pagination.page);
            } else {
                showToast('error', 'Search failed');
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            showToast('error', 'Search error occurred');
        });
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    if (document.getElementById('statusFilter')) {
        document.getElementById('statusFilter').value = '';
    }
    if (document.getElementById('offerFilter')) {
        document.getElementById('offerFilter').value = '';
    }

    fetch('/applications/search?q=&status=')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTableWithSearchResults(data.applications);
                updatePagination(data.pagination.totalPages, data.pagination.page);
            }
        })
        .catch(error => {
            console.error('Clear search error:', error);
            location.reload();
        });
}

function updateTableWithSearchResults(applications) {
    const tbody = document.getElementById('applicationsTableBody');

    if (!applications || applications.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="${isRecruiter() ? '8' : '6'}" class="text-center py-5">
                    <i class="bi bi-search" style="font-size: 3rem; color: #dee2e6;"></i>
                    <h5 class="text-muted mt-3">No matching applications found</h5>
                    <p class="text-muted">Try different search terms or filters</p>
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    applications.forEach(application => {
        const statusClass = getStatusClass(application.status);
        const statusText = getStatusText(application.status);
        const isPending = application.status === 'PENDING';
        const isAccepted = application.status === 'ACCEPTED';
        const isRejected = application.status === 'REJECTED';

        html += `
        <tr id="application-${application.id}">
            ${isRecruiter() ? `
                <td class="fw-semibold">${application.candidateName}</td>
                <td>${application.candidateEmail}</td>
            ` : ''}
            <td>
                <div class="fw-semibold">${application.offerTitle}</div>
                <small class="text-muted">Remote</small>
            </td>
            <td>
                <div class="cover-letter-preview">
                    ${application.coverLetter ? (application.coverLetter.length > 100 ? application.coverLetter.substring(0, 100) + '...' : application.coverLetter) : 'No cover letter'}
                </div>
            </td>
            <td>
                ${application.resume ? `
                    <a href="#" class="file-download-btn" onclick="event.preventDefault(); showApplicationDetails(${application.id})">
                        <i class="bi bi-file-earmark-pdf me-2"></i>View CV
                    </a>
                ` : '<span class="text-muted">No CV</span>'}
            </td>
            <td>
                <span class="status-badge ${statusClass}">
                    ${statusText}
                </span>
            </td>
            <td>${application.createdAt || ''}</td>
            <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-info action-btn"
                            onclick="showApplicationDetails(${application.id})"
                            title="View Details">
                        <i class="bi bi-eye"></i>
                    </button>

                    ${isRecruiter() ? `
                        <button type="button" class="btn btn-outline-success action-btn"
                                onclick="updateApplicationStatus(${application.id}, 'ACCEPTED')"
                                title="Accept Application"
                                ${isAccepted ? 'disabled' : ''}>
                            <i class="bi bi-check-circle"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger action-btn"
                                onclick="updateApplicationStatus(${application.id}, 'REJECTED')"
                                title="Reject Application"
                                ${isRejected ? 'disabled' : ''}>
                            <i class="bi bi-x-circle"></i>
                        </button>
                        ${isAccepted || isRejected ? `
                            <button type="button" class="btn btn-outline-warning action-btn"
                                    onclick="updateApplicationStatus(${application.id}, 'PENDING')"
                                    title="Reset to Pending">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        ` : ''}
                    ` : `
                        ${isPending ? `
                            <button type="button" class="btn btn-outline-primary action-btn"
                                    onclick="showEditApplicationModal(${application.id})"
                                    title="Edit Application">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger action-btn"
                                    onclick="deleteApplication(${application.id})"
                                    title="Delete Application">
                                <i class="bi bi-trash"></i>
                            </button>
                        ` : ''}
                    `}
                </div>
            </td>
        </tr>
        `;
    });

    tbody.innerHTML = html;
}

function updatePagination(totalPages, currentPage) {
    const paginationContainer = document.getElementById('paginationContainer');
    if (!paginationContainer || totalPages <= 1) {
        if (paginationContainer) {
            paginationContainer.innerHTML = '';
        }
        return;
    }

    let html = '<nav><ul class="pagination justify-content-center">';

    // Previous button
    if (currentPage > 1) {
        html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadPage(${currentPage - 1})">Previous</a>
                 </li>`;
    } else {
        html += `<li class="page-item disabled">
                    <span class="page-link">Previous</span>
                 </li>`;
    }

    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active">
                        <span class="page-link">${i}</span>
                     </li>`;
        } else {
            html += `<li class="page-item">
                        <a class="page-link" href="#" onclick="loadPage(${i})">${i}</a>
                     </li>`;
        }
    }

    // Next button
    if (currentPage < totalPages) {
        html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadPage(${currentPage + 1})">Next</a>
                 </li>`;
    } else {
        html += `<li class="page-item disabled">
                    <span class="page-link">Next</span>
                 </li>`;
    }

    html += '</ul></nav>';
    paginationContainer.innerHTML = html;
}

function loadPage(page) {
    const searchTerm = document.getElementById('searchInput')?.value || '';
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    const offerFilter = document.getElementById('offerFilter') ? document.getElementById('offerFilter').value : '';

    let url = `/applications/search?q=${encodeURIComponent(searchTerm)}&status=${encodeURIComponent(statusFilter)}&page=${page}`;
    if (offerFilter) {
        url += `&offer=${offerFilter}`;
    }

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTableWithSearchResults(data.applications);
                updatePagination(data.pagination.totalPages, page);
                document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth' });
            }
        })
        .catch(error => {
            console.error('Page load error:', error);
            showToast('error', 'Error loading page');
        });
}

// Application CRUD functions
function showApplicationDetails(applicationId) {
    fetch(`/applications/${applicationId}/show`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const app = data.application;

                // Fill modal with data
                document.getElementById('viewApplicationId').textContent = app.id;
                document.getElementById('viewCandidateName').textContent = app.candidateName;
                document.getElementById('viewCandidateEmail').textContent = app.candidateEmail;
                document.getElementById('viewCandidatePhone').textContent = app.candidatePhone || 'Not provided';
                document.getElementById('viewOfferTitle').textContent = app.offerTitle;
                document.getElementById('viewCoverLetter').textContent = app.coverLetter || 'No cover letter provided';
                document.getElementById('viewApplicationDate').textContent = app.createdAt;

                // Set status badge
                const statusBadge = document.getElementById('viewApplicationStatus');
                statusBadge.textContent = app.statusText;
                statusBadge.className = 'badge ' + getStatusClass(app.status);

                // Handle resume
                const resumeLink = document.getElementById('viewResumeLink');
                const resumeText = document.getElementById('viewResumeText');
                const resumeInfo = document.getElementById('viewResumeInfo');

                if (app.resumePath) {
                    resumeText.textContent = 'Resume attached: ' + (app.resume || 'CV.pdf');
                    resumeLink.href = app.resumePath;
                    resumeLink.style.display = 'inline-block';
                    resumeInfo.className = 'alert alert-success';
                } else {
                    resumeText.textContent = 'No resume attached';
                    resumeLink.style.display = 'none';
                    resumeInfo.className = 'alert alert-info';
                }

                // Quick actions for recruiter
                if (isRecruiter()) {
                    const quickActions = document.getElementById('quickActions');
                    let actionsHtml = '';

                    if (app.status !== 'ACCEPTED') {
                        actionsHtml += `
                            <button type="button" class="btn btn-success"
                                    onclick="updateApplicationStatus(${app.id}, 'ACCEPTED');">
                                <i class="bi bi-check-circle me-2"></i>Accept Application
                            </button>
                        `;
                    }

                    if (app.status !== 'REJECTED') {
                        actionsHtml += `
                            <button type="button" class="btn btn-danger"
                                    onclick="updateApplicationStatus(${app.id}, 'REJECTED');">
                                <i class="bi bi-x-circle me-2"></i>Reject Application
                            </button>
                        `;
                    }

                    if (app.status === 'ACCEPTED' || app.status === 'REJECTED') {
                        actionsHtml += `
                            <button type="button" class="btn btn-warning"
                                    onclick="updateApplicationStatus(${app.id}, 'PENDING');">
                                <i class="bi bi-arrow-clockwise me-2"></i>Reset to Pending
                            </button>
                        `;
                    }

                    quickActions.innerHTML = actionsHtml;
                }

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('viewApplicationModal'));
                modal.show();
            }
        })
        .catch(error => {
            console.error('Error loading application:', error);
            showToast('error', 'Failed to load application details');
        });
}

function updateApplicationStatus(applicationId, status) {
    if (!confirm(`Are you sure you want to ${status.toLowerCase()} this application?`)) {
        return;
    }

    fetch(`/applications/${applicationId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);

            // Update status in table
            const statusCell = document.querySelector(`#application-${applicationId} td:nth-child(${isRecruiter() ? 6 : 4})`);
            if (statusCell) {
                const newClass = getStatusClass(data.application.status);
                const newText = getStatusText(data.application.status);
                statusCell.innerHTML = `<span class="status-badge ${newClass}">${newText}</span>`;
            }

            // Update action buttons
            const actionCell = document.querySelector(`#application-${applicationId} td:last-child .btn-group`);
            if (actionCell && isRecruiter()) {
                let buttonsHtml = `
                    <button type="button" class="btn btn-outline-info action-btn"
                            onclick="showApplicationDetails(${applicationId})"
                            title="View Details">
                        <i class="bi bi-eye"></i>
                    </button>
                `;

                if (data.application.status !== 'ACCEPTED') {
                    buttonsHtml += `
                        <button type="button" class="btn btn-outline-success action-btn"
                                onclick="updateApplicationStatus(${applicationId}, 'ACCEPTED')"
                                title="Accept Application">
                            <i class="bi bi-check-circle"></i>
                        </button>
                    `;
                }

                if (data.application.status !== 'REJECTED') {
                    buttonsHtml += `
                        <button type="button" class="btn btn-outline-danger action-btn"
                                onclick="updateApplicationStatus(${applicationId}, 'REJECTED')"
                                title="Reject Application">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    `;
                }

                if (data.application.status === 'ACCEPTED' || data.application.status === 'REJECTED') {
                    buttonsHtml += `
                        <button type="button" class="btn btn-outline-warning action-btn"
                                onclick="updateApplicationStatus(${applicationId}, 'PENDING')"
                                title="Reset to Pending">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    `;
                }

                actionCell.innerHTML = buttonsHtml;
            }

            // Reload stats
            loadStats();

        } else {
            showToast('error', data.error || 'Failed to update status');
        }
    })
    .catch(error => {
        console.error('Status update error:', error);
        showToast('error', 'Network error occurred');
    });
}

// Helper functions
function isRecruiter() {
    return document.body.classList.contains('role-recruiter') ||
           {% if is_granted('ROLE_RECRUITER') %}true{% else %}false{% endif %};
}

function getStatusClass(status) {
    switch(status) {
        case 'ACCEPTED': return 'bg-success';
        case 'REJECTED': return 'bg-danger';
        default: return 'bg-warning';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'ACCEPTED': return 'Accepted';
        case 'REJECTED': return 'Rejected';
        default: return 'Pending';
    }
}

// Toast functions (reuse from offers page)
function showToast(type, message) {
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        container.style.zIndex = '1060';
        document.body.appendChild(container);
    }

    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-white border-0`;

    if (type === 'error') {
        toast.classList.add('bg-danger');
    } else if (type === 'success') {
        toast.classList.add('bg-success');
    } else if (type === 'warning') {
        toast.classList.add('bg-warning');
    } else {
        toast.classList.add('bg-info');
    }

    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body" style="color: white; font-weight: 500;">
                <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-exclamation-circle' : 'bi-info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

function createToastContainer() {
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        container.style.zIndex = '1060';
        document.body.appendChild(container);
    }
    return container;
}

// Add enter key support for search
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
});

let applicationToDelete = null;

// SHOW EDIT APPLICATION MODAL
function showEditApplicationModal(applicationId) {
    fetch(`/applications/${applicationId}/edit`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const app = data.application;

                document.getElementById('editApplicationId').value = app.id;
                document.getElementById('editApplicationOfferTitle').textContent = app.offerTitle;
                document.getElementById('editCoverLetter').value = app.coverLetter || '';

                // Clear previous errors
                document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editApplicationModal'));
                modal.show();
            } else {
                showToast('error', data.error || 'Failed to load application');
            }
        })
        .catch(error => {
            console.error('Edit application error:', error);
            showToast('error', 'Failed to load application details');
        });
}

// UPDATE APPLICATION
function updateApplication() {
    const applicationId = document.getElementById('editApplicationId').value;
    const coverLetter = document.getElementById('editCoverLetter').value;
    const resumeFile = document.getElementById('editResumeFile').files[0];

    // Clear previous errors
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

    // Validate form
    let isValid = true;

    if (!coverLetter.trim()) {
        document.getElementById('editCoverLetter').classList.add('is-invalid');
        document.getElementById('editCoverLetterError').textContent = 'Cover letter is required';
        isValid = false;
    }

    if (resumeFile && resumeFile.size > 5 * 1024 * 1024) { // 5MB limit
        document.getElementById('editResumeFile').classList.add('is-invalid');
        document.getElementById('editResumeFileError').textContent = 'File size must be less than 5MB';
        isValid = false;
    }

    if (!isValid) return;

    // Prepare form data
    const formData = new FormData();
    formData.append('coverLetter', coverLetter);
    if (resumeFile) {
        formData.append('resume', resumeFile);
    }

    // Update application
    fetch(`/applications/${applicationId}/update`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editApplicationModal'));
            modal.hide();

            showToast('success', data.message);

            // Update cover letter preview in table
            const coverLetterCell = document.querySelector(`#application-${applicationId} td:nth-child(3)`);
            if (coverLetterCell) {
                const preview = coverLetter.length > 100 ? coverLetter.substring(0, 100) + '...' : coverLetter;
                coverLetterCell.querySelector('.cover-letter-preview').textContent = preview;
            }

        } else {
            showToast('error', data.error || 'Update failed');
        }
    })
    .catch(error => {
        console.error('Update error:', error);
        showToast('error', 'Network error occurred');
    });
}

// DELETE APPLICATION
function deleteApplication(applicationId) {
    applicationToDelete = applicationId;

    // Show confirmation modal
    const modal = new bootstrap.Modal(document.getElementById('deleteApplicationModal'));
    modal.show();
}

// CONFIRM DELETE APPLICATION
function confirmDeleteApplication() {
    if (!applicationToDelete) return;

    fetch(`/applications/${applicationToDelete}/delete`, {
        method: 'DELETE',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteApplicationModal'));
        if (modal) modal.hide();

        if (data.success) {
            // Remove row from table
            const row = document.getElementById(`application-${applicationToDelete}`);
            if (row) row.remove();

            showToast('success', data.message);

            // Check if table is empty
            const tbody = document.getElementById('applicationsTableBody');
            if (tbody && tbody.children.length === 0) {
                // Add empty state message
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: #dee2e6;"></i>
                            <h5 class="text-muted mt-3">No applications found</h5>
                            <p class="text-muted">You haven't applied to any job offers yet</p>
                        </td>
                    </tr>
                `;
            }

            // Reload stats
            loadStats();

        } else {
            showToast('error', data.error || 'Delete failed');
        }

        // Reset variable
        applicationToDelete = null;
    })
    .catch(error => {
        console.error('Delete error:', error);
        showToast('error', 'Network error occurred');
        applicationToDelete = null;
    });
}
</script>
{% endblock %}
