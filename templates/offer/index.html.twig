{% extends 'base.html.twig' %}

{% block title %}Job Offers - HireFlow{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }
    .skill-badge {
        background: #e8f4fc;
        color: #3498db;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        margin: 2px;
        display: inline-block;
    }
    .action-btn {
        padding: 5px 12px;
        font-size: 0.85rem;
        border-radius: 4px;
        margin: 2px;
    }
    .modal-lg-custom {
        max-width: 800px;
    }
    .offer-description {
        white-space: pre-wrap;
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Job Offers</h1>
            <p class="text-muted mb-0">
                {% if is_granted('ROLE_RECRUITER') %}
                    Manage your job offers - All actions in one place
                {% else %}
                    Browse available positions
                {% endif %}
            </p>
        </div>

        <!-- Create New Button (only for recruiters) -->
        {% if is_granted('ROLE_RECRUITER') %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createOfferModal">
                <i class="bi bi-plus-circle me-2"></i>Create New Offer
            </button>
        {% endif %}
    </div>

    {# search #}
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search by title or description...">
                <input type="text" class="form-control" id="skillsFilter" placeholder="Filter by skills (comma separated)...">
                <button class="btn btn-outline-primary" onclick="performSearch()">
                    <i class="bi bi-search"></i> Search
                </button>
                <button class="btn btn-outline-secondary" onclick="clearSearch()">
                    <i class="bi bi-x-circle"></i> Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Offers Table -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Skills</th>
                        <th>Location</th>
                        <th>Salary</th>
                        <th>Type</th>
                        <th>Applications</th>
                        <th>Created</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="offersTableBody">
                    {% for offer in offers %}
                    <tr id="offer-{{ offer.id }}">
                        <td class="fw-semibold">{{ offer.title }}</td>
                        <td>{{ offer.description|slice(0, 80) }}...</td>
                        <td>
                            {% for skill in offer.skills|split(',')|slice(0, 2) %}
                                {% if skill|trim %}
                                    <span class="skill-badge">{{ skill|trim }}</span>
                                {% endif %}
                            {% endfor %}
                            {% if offer.skills|split(',')|length > 2 %}
                                <span class="skill-badge">+{{ offer.skills|split(',')|length - 2 }}</span>
                            {% endif %}
                        </td>
                        <td>{{ offer.location|default('Remote') }}</td>
                        <td>{{ offer.salary|default('Not specified') }}</td>
                        <td>
                            <span class="badge bg-secondary">{{ offer.contractType|default('Full-time') }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-primary">{{ offer.applications|length }}</span>
                        </td>
                        <td>{{ offer.createdAt|date('M d, Y') }}</td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <!-- View Details Button -->
                                <button type="button" class="btn btn-outline-info action-btn"
                                        onclick="showOfferDetails({{ offer.id }})"
                                        title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>

                                <!-- Edit Button (only for recruiter who owns the offer) -->
                                {% if is_granted('ROLE_RECRUITER') and offer.recruiter.id == app.user.id %}
                                    <button type="button" class="btn btn-outline-primary action-btn"
                                            onclick="openEditOfferModal({{ offer.id }})"
                                            title="Edit Offer">
                                        <i class="bi bi-pencil"></i>
                                    </button>

                                    <!-- Delete Button -->
                                    <button type="button" class="btn btn-outline-danger action-btn"
                                            onclick="deleteOffer({{ offer.id }})"
                                            title="Delete Offer">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                {% endif %}

                                <!-- Apply Button (for candidates) -->
                                {% if is_granted('ROLE_CANDIDATE') %}
                                    <button type="button" class="btn btn-success action-btn"
                                            onclick="showApplyModal({{ offer.id }}, '{{ offer.title|e('js') }}')"
                                            title="Apply Now">
                                        <i class="bi bi-send"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <i class="bi bi-briefcase" style="font-size: 3rem; color: #dee2e6;"></i>
                            <h5 class="text-muted mt-3">No job offers found</h5>
                            {% if is_granted('ROLE_RECRUITER') %}
                                <p class="text-muted">Click "Create New Offer" to add your first job offer</p>
                            {% else %}
                                <p class="text-muted">Check back soon for new opportunities</p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- CREATE OFFER MODAL -->
<div class="modal fade" id="createOfferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-lg-custom">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Job Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {{ form_start(form, {'attr': {'id': 'offerForm'}}) }}

                <div class="row mb-3">
                    <div class="col-12">
                        {{ form_label(form.title) }}
                        {{ form_widget(form.title) }}
                        <div class="invalid-feedback" id="titleError"></div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        {{ form_label(form.description) }}
                        {{ form_widget(form.description) }}
                        <div class="invalid-feedback" id="descriptionError"></div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        {{ form_label(form.skills) }}
                        {{ form_widget(form.skills) }}
                        <small class="form-text text-muted">Separate skills with commas</small>
                        <div class="invalid-feedback" id="skillsError"></div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form_label(form.location) }}
                        {{ form_widget(form.location) }}
                    </div>
                    <div class="col-md-6">
                        {{ form_label(form.salary) }}
                        {{ form_widget(form.salary) }}
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        {{ form_label(form.contractType) }}
                        {{ form_widget(form.contractType) }}
                    </div>
                </div>

                {{ form_end(form) }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createOffer()">
                    <i class="bi bi-check-circle me-2"></i>Create Offer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- EDIT OFFER MODAL -->
<div class="modal fade" id="editOfferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-lg-custom">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Job Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editOfferForm">
                    <input type="hidden" id="editOfferId">

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editTitle" class="form-label">Job Title</label>
                            <input type="text" class="form-control" id="editTitle" required>
                            <div class="invalid-feedback" id="editTitleError"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" rows="5" required></textarea>
                            <div class="invalid-feedback" id="editDescriptionError"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="editSkills" class="form-label">Required Skills</label>
                            <textarea class="form-control" id="editSkills" rows="3" required></textarea>
                            <small class="form-text text-muted">Separate skills with commas</small>
                            <div class="invalid-feedback" id="editSkillsError"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="editLocation">
                        </div>
                        <div class="col-md-6">
                            <label for="editSalary" class="form-label">Salary</label>
                            <input type="text" class="form-control" id="editSalary">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="editContractType" class="form-label">Contract Type</label>
                            <select class="form-select" id="editContractType">
                                <option value="">Select type</option>
                                <option value="Full-time">Full-time</option>
                                <option value="Part-time">Part-time</option>
                                <option value="Contract">Contract</option>
                                <option value="Remote">Remote</option>
                                <option value="Internship">Internship</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateOffer()">
                    <i class="bi bi-check-circle me-2"></i>Update Offer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- VIEW OFFER MODAL -->
<div class="modal fade" id="viewOfferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-lg-custom">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewOfferTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <span class="badge bg-primary" id="viewContractType"></span>
                            <span class="badge bg-secondary" id="viewLocation"></span>
                            <span class="badge bg-success" id="viewSalary"></span>
                            <span class="badge bg-info">
                                <i class="bi bi-calendar me-1"></i><span id="viewCreatedAt"></span>
                            </span>
                            <span class="badge bg-warning">
                                <i class="bi bi-person me-1"></i><span id="viewRecruiter"></span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="mb-2">Description</h6>
                        <div class="bg-light p-3 rounded offer-description" id="viewDescription"></div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="mb-2">Required Skills</h6>
                        <div id="viewSkills"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-info-circle me-3" style="font-size: 1.5rem;"></i>
                                <div>
                                    <strong>Applications:</strong> <span id="viewApplicationsCount">0</span> candidates have applied
                                    {% if is_granted('ROLE_RECRUITER') %}
                                        <br><small>Click "View Applications" in the table to manage applications</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="paginationContainer" class="mt-4"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {% if is_granted('ROLE_CANDIDATE') %}
                    <button type="button" class="btn btn-primary" onclick="applyToOffer()" disabled>
                        <i class="bi bi-send me-2"></i>Apply Now
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- APPLY TO OFFER MODAL -->
<div class="modal fade" id="applyOfferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-lg-custom">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Apply to <span id="applyOfferTitle"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="applyForm">
                    <input type="hidden" id="applyOfferId">

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="coverLetter" class="form-label">Cover Letter *</label>
                            <textarea class="form-control" id="coverLetter" rows="5" required
                                      placeholder="Introduce yourself and explain why you're a good fit for this position..."></textarea>
                            <div class="invalid-feedback" id="coverLetterError"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="resumeFile" class="form-label">Resume / CV *</label>
                            <input type="file" class="form-control" id="resumeFile" accept=".pdf,.doc,.docx,.txt" required>
                            <small class="form-text text-muted">
                                Accepted formats: PDF, DOC, DOCX, TXT (Max 5MB)
                            </small>
                            <div class="invalid-feedback" id="resumeFileError"></div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmInfo" required>
                                <label class="form-check-label" for="confirmInfo">
                                    I confirm that the information provided is accurate and complete
                                </label>
                                <div class="invalid-feedback" id="confirmInfoError"></div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Your application will be submitted to the recruiter. You can track its status in "My Applications".
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitApplication()">
                    <i class="bi bi-send me-2"></i>Submit Application
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts_body %}
<script>
// Global variables
let currentOfferId = null;

// CREATE OFFER
function createOffer() {
    const form = document.getElementById('offerForm');
    if (!form) {
        showToast('error', 'Form not found!');
        return;
    }

    const formData = new FormData(form);

    fetch('/offers/new', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                // Handle validation errors
                if (data.errors && Array.isArray(data.errors)) {
                    showFormErrors(data.errors);
                    return { success: false };
                }
                throw new Error(data.error || 'Request failed');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('createOfferModal'));
            if (modal) modal.hide();
            showToast('success', data.message);
            setTimeout(() => location.reload(), 1000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', error.message || 'An error occurred');
    });
}

// OPEN EDIT MODAL
function openEditOfferModal(offerId) {
    currentOfferId = offerId;

    fetch(`/offers/${offerId}/edit`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fill form with offer data
                document.getElementById('editOfferId').value = data.offer.id;
                document.getElementById('editTitle').value = data.offer.title;
                document.getElementById('editDescription').value = data.offer.description;
                document.getElementById('editSkills').value = data.offer.skills;
                document.getElementById('editLocation').value = data.offer.location || '';
                document.getElementById('editSalary').value = data.offer.salary || '';
                document.getElementById('editContractType').value = data.offer.contractType || '';

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editOfferModal'));
                modal.show();
            } else {
                showToast('error', data.error || 'Failed to load offer');
            }
        });
}

// UPDATE OFFER
function updateOffer() {
    const offerId = document.getElementById('editOfferId').value;
    const data = {
        title: document.getElementById('editTitle').value,
        description: document.getElementById('editDescription').value,
        skills: document.getElementById('editSkills').value,
        location: document.getElementById('editLocation').value,
        salary: document.getElementById('editSalary').value,
        contractType: document.getElementById('editContractType').value
    };

    fetch(`/offers/${offerId}/update`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editOfferModal'));
            modal.hide();

            // Show success
            showToast('success', data.message);

            // Update table row (simplified - reload for now)
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('error', data.error || 'Update failed');
        }
    });
}

// DELETE OFFER
function deleteOffer(offerId) {
    if (!confirm('Are you sure you want to delete this offer?')) return;

    // First try to delete just the offer
    fetch(`/offers/${offerId}/delete?deleteMode=offer_only`, {
        method: 'DELETE',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success - remove row from table
            const row = document.getElementById(`offer-${offerId}`);
            if (row) row.remove();

            showToast('success', data.message);

            // Check if table is empty
            const tbody = document.getElementById('offersTableBody');
            if (tbody && tbody.children.length === 0) {
                // Add empty state message
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <i class="bi bi-briefcase" style="font-size: 3rem; color: #dee2e6;"></i>
                            <h5 class="text-muted mt-3">No job offers found</h5>
                            {% if is_granted('ROLE_RECRUITER') %}
                                <p class="text-muted">Click "Create New Offer" to add your first job offer</p>
                            {% else %}
                                <p class="text-muted">Check back soon for new opportunities</p>
                            {% endif %}
                        </td>
                    </tr>
                `;
            }
        } else {
            // Check if it's because of applications
            if (data.hasApplications) {
                showDeleteConfirmationModal(offerId, data.applicationsCount);
            } else {
                showToast('error', data.error || 'Delete failed');
            }
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showToast('error', 'Network error occurred');
    });
}

// SEARCH FUNCTIONS
function performSearch() {
    const searchTerm = document.getElementById('searchInput').value;
    const skillsFilter = document.getElementById('skillsFilter').value;

    fetch(`/offers/search?q=${encodeURIComponent(searchTerm)}&skills=${encodeURIComponent(skillsFilter)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTableWithSearchResults(data.offers);
                updatePagination(data.pagination.totalPages, data.pagination.page);
            } else {
                showToast('error', 'Search failed');
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            showToast('error', 'Search error occurred');
        });
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('skillsFilter').value = '';

    // Reload the page to show all offers
    fetch(`/offers/search?q=&skills=`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTableWithSearchResults(data.offers);
                updatePagination(data.pagination.totalPages, data.pagination.page);
            }
        })
        .catch(error => {
            console.error('Clear search error:', error);
            location.reload(); // Fallback to full reload
        });
}

function updateTableWithSearchResults(offers) {
    const tbody = document.getElementById('offersTableBody');

    if (!offers || offers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-5">
                    <i class="bi bi-search" style="font-size: 3rem; color: #dee2e6;"></i>
                    <h5 class="text-muted mt-3">No matching offers found</h5>
                    <p class="text-muted">Try different search terms or filters</p>
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    offers.forEach(offer => {
        // Process skills for badges
        const skillsArray = offer.skills ? offer.skills.split(',').map(s => s.trim()) : [];
        const skillsDisplay = skillsArray.slice(0, 2);
        const extraSkillsCount = Math.max(0, skillsArray.length - 2);

        let skillsHtml = '';
        skillsDisplay.forEach(skill => {
            if (skill) {
                skillsHtml += `<span class="skill-badge">${skill}</span>`;
            }
        });
        if (extraSkillsCount > 0) {
            skillsHtml += `<span class="skill-badge">+${extraSkillsCount}</span>`;
        }

        html += `
        <tr id="offer-${offer.id}">
            <td class="fw-semibold">${offer.title}</td>
            <td>${offer.description ? (offer.description.length > 80 ? offer.description.substring(0, 80) + '...' : offer.description) : ''}</td>
            <td>${skillsHtml || 'Not specified'}</td>
            <td>${offer.location || 'Remote'}</td>
            <td>${offer.salary || 'Not specified'}</td>
            <td><span class="badge bg-secondary">${offer.contractType || 'Full-time'}</span></td>
            <td class="text-center"><span class="badge bg-primary">${offer.applicationsCount || 0}</span></td>
            <td>${offer.createdAt || ''}</td>
            <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-info action-btn"
                            onclick="showOfferDetails(${offer.id})"
                            title="View Details">
                        <i class="bi bi-eye"></i>
                    </button>
                    {% if is_granted('ROLE_RECRUITER') %}
                        <button type="button" class="btn btn-outline-primary action-btn"
                                onclick="openEditOfferModal(${offer.id})"
                                title="Edit Offer">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger action-btn"
                                onclick="deleteOffer(${offer.id})"
                                title="Delete Offer">
                            <i class="bi bi-trash"></i>
                        </button>
                    {% endif %}
                    {% if is_granted('ROLE_CANDIDATE') %}
                        <button type="button" class="btn btn-success action-btn"
                                onclick="applyToOffer(${offer.id})"
                                title="Apply Now" disabled>
                            <i class="bi bi-send"></i>
                        </button>
                    {% endif %}
                </div>
            </td>
        </tr>
        `;
    });

    tbody.innerHTML = html;
}

function updatePagination(totalPages, currentPage) {
    const paginationContainer = document.getElementById('paginationContainer');
    if (!paginationContainer || totalPages <= 1) {
        if (paginationContainer) {
            paginationContainer.innerHTML = '';
        }
        return;
    }

    let html = '<nav><ul class="pagination justify-content-center">';

    // Previous button
    if (currentPage > 1) {
        html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadPage(${currentPage - 1})">Previous</a>
                 </li>`;
    } else {
        html += `<li class="page-item disabled">
                    <span class="page-link">Previous</span>
                 </li>`;
    }

    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active">
                        <span class="page-link">${i}</span>
                     </li>`;
        } else {
            html += `<li class="page-item">
                        <a class="page-link" href="#" onclick="loadPage(${i})">${i}</a>
                     </li>`;
        }
    }

    // Next button
    if (currentPage < totalPages) {
        html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadPage(${currentPage + 1})">Next</a>
                 </li>`;
    } else {
        html += `<li class="page-item disabled">
                    <span class="page-link">Next</span>
                 </li>`;
    }

    html += '</ul></nav>';
    paginationContainer.innerHTML = html;
}

function loadPage(page) {
    const searchTerm = document.getElementById('searchInput')?.value || '';
    const skillsFilter = document.getElementById('skillsFilter')?.value || '';

    fetch(`/offers/search?q=${encodeURIComponent(searchTerm)}&skills=${encodeURIComponent(skillsFilter)}&page=${page}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTableWithSearchResults(data.offers);
                updatePagination(data.pagination.totalPages, page);
                // Scroll to top of table
                document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth' });
            }
        })
        .catch(error => {
            console.error('Page load error:', error);
            showToast('error', 'Error loading page');
        });
}

// DELETE CONFIRMATION MODAL
function showDeleteConfirmationModal(offerId, applicationsCount) {
    // Remove existing modal if any
    const existingModal = document.getElementById('deleteConfirmationModal');
    if (existingModal) existingModal.remove();

    // Create modal HTML
    const modalHTML = `
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Delete Offer with Applications
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-octagon me-2"></i>
                        <strong>Warning:</strong> This offer has <strong>${applicationsCount}</strong> application(s).
                    </div>
                    <p>If you delete this offer, all related applications will also be permanently deleted, including:</p>
                    <ul>
                        <li>Candidate CV/resume files</li>
                        <li>Cover letters</li>
                        <li>Application history</li>
                    </ul>
                    <p class="mb-0"><strong>Are you sure you want to continue?</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="deleteOfferWithApplications(${offerId})">
                        <i class="bi bi-trash me-2"></i>Delete Offer & Applications
                    </button>
                </div>
            </div>
        </div>
    </div>
    `;

    // Add to document
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
    modal.show();

    // Remove modal from DOM when hidden
    modal._element.addEventListener('hidden.bs.modal', () => {
        modal._element.remove();
    });
}

// In your offers.js file, add these functions:

// SHOW APPLY MODAL
function showApplyModal(offerId, offerTitle) {
    document.getElementById('applyOfferId').value = offerId;
    document.getElementById('applyOfferTitle').textContent = offerTitle;

    // Reset form
    document.getElementById('applyForm').reset();
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('applyOfferModal'));
    modal.show();
}

// SUBMIT APPLICATION
function submitApplication() {
    const offerId = document.getElementById('applyOfferId').value;
    const coverLetter = document.getElementById('coverLetter').value;
    const resumeFile = document.getElementById('resumeFile').files[0];
    const confirmInfo = document.getElementById('confirmInfo').checked;

    // Clear previous errors
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

    // Validate form
    let isValid = true;

    if (!coverLetter.trim()) {
        document.getElementById('coverLetter').classList.add('is-invalid');
        document.getElementById('coverLetterError').textContent = 'Cover letter is required';
        isValid = false;
    }

    if (!resumeFile) {
        document.getElementById('resumeFile').classList.add('is-invalid');
        document.getElementById('resumeFileError').textContent = 'Resume file is required';
        isValid = false;
    } else if (resumeFile.size > 5 * 1024 * 1024) { // 5MB limit
        document.getElementById('resumeFile').classList.add('is-invalid');
        document.getElementById('resumeFileError').textContent = 'File size must be less than 5MB';
        isValid = false;
    }

    if (!confirmInfo) {
        document.getElementById('confirmInfo').classList.add('is-invalid');
        document.getElementById('confirmInfoError').textContent = 'Please confirm the information';
        isValid = false;
    }

    if (!isValid) return;

    // Prepare form data
    const formData = new FormData();
    formData.append('offerId', offerId);
    formData.append('coverLetter', coverLetter);
    formData.append('resume', resumeFile);

    // Submit application
    fetch('/applications/new', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // First, check if response is HTML instead of JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                console.error('Server returned HTML instead of JSON:', text.substring(0, 500));
                throw new Error('Server returned HTML. Check server logs.');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('applyOfferModal'));
            modal.hide();

            showToast('success', data.message);

            // Update applications count in the table
            const applicationsBadge = document.querySelector(`#offer-${offerId} .badge.bg-primary`);
            if (applicationsBadge) {
                const currentCount = parseInt(applicationsBadge.textContent) || 0;
                applicationsBadge.textContent = currentCount + 1;
            }
        } else {
            showToast('error', data.error || 'Application submission failed');
        }
    })
    .catch(error => {
        console.error('Application error:', error);
        showToast('error', error.message || 'An error occurred');
    });
}

function deleteOfferWithApplications(offerId) {
    fetch(`/offers/${offerId}/delete?deleteMode=with_applications`, {
        method: 'DELETE',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal'));
        if (modal) modal.hide();

        if (data.success) {
            // Remove row from table
            const row = document.getElementById(`offer-${offerId}`);
            if (row) row.remove();

            showToast('success', data.message);

            // Check if table is empty
            const tbody = document.getElementById('offersTableBody');
            if (tbody && tbody.children.length === 0) {
                // Add empty state message
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <i class="bi bi-briefcase" style="font-size: 3rem; color: #dee2e6;"></i>
                            <h5 class="text-muted mt-3">No job offers found</h5>
                            {% if is_granted('ROLE_RECRUITER') %}
                                <p class="text-muted">Click "Create New Offer" to add your first job offer</p>
                            {% else %}
                                <p class="text-muted">Check back soon for new opportunities</p>
                            {% endif %}
                        </td>
                    </tr>
                `;
            }
        } else {
            showToast('error', data.error || 'Delete failed');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showToast('error', 'Network error occurred');
    });
}

// SHOW OFFER DETAILS
function showOfferDetails(offerId) {
    fetch(`/offers/${offerId}/show`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const offer = data.offer;

                // Fill modal with data
                document.getElementById('viewOfferTitle').textContent = offer.title;
                document.getElementById('viewDescription').textContent = offer.description;
                document.getElementById('viewContractType').textContent = offer.contractType || 'Full-time';
                document.getElementById('viewLocation').textContent = offer.location || 'Remote';
                document.getElementById('viewSalary').textContent = offer.salary || 'Not specified';
                document.getElementById('viewCreatedAt').textContent = offer.createdAt;
                document.getElementById('viewRecruiter').textContent = offer.recruiter;
                document.getElementById('viewApplicationsCount').textContent = offer.applicationsCount;

                // Render skills as badges
                const skillsContainer = document.getElementById('viewSkills');
                skillsContainer.innerHTML = '';
                if (offer.skills) {
                    offer.skills.split(',').forEach(skill => {
                        if (skill.trim()) {
                            const badge = document.createElement('span');
                            badge.className = 'skill-badge me-2 mb-2';
                            badge.textContent = skill.trim();
                            skillsContainer.appendChild(badge);
                        }
                    });
                }

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('viewOfferModal'));
                modal.show();
            }
        });
}

// APPLY TO OFFER (placeholder for now)
function applyToOffer(offerId) {
    alert('Apply functionality will be implemented in the Applications CRUD section');
}

// HELPER FUNCTIONS
function showToast(type, message) {
    // Create toast container if it doesn't exist
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        container.style.zIndex = '1060';
        document.body.appendChild(container);
    }

    // Create toast
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-white border-0`;

    // Set background color
    if (type === 'error') {
        toast.classList.add('bg-danger');
    } else if (type === 'success') {
        toast.classList.add('bg-success');
    } else if (type === 'warning') {
        toast.classList.add('bg-warning');
    } else {
        toast.classList.add('bg-info');
    }

    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body" style="color: white; font-weight: 500;">
                <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-exclamation-circle' : 'bi-info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

    container.appendChild(toast);

    // Show toast
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();

    // Remove from DOM after hide
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '1060';
    document.body.appendChild(container);
    return container;
}

function showFormErrors(errors) {
    // Clear previous errors
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

    // Show new errors
    errors.forEach(error => {
        const field = error.toLowerCase().includes('title') ? 'title' :
                    error.toLowerCase().includes('description') ? 'description' :
                    error.toLowerCase().includes('skills') ? 'skills' : null;

        if (field) {
            const input = document.getElementById(field === 'skills' ? 'skills' : field);
            const errorDiv = document.getElementById(field + 'Error');

            if (input && errorDiv) {
                input.classList.add('is-invalid');
                errorDiv.textContent = error;
            }
        }
    });
}

// Enable enter key for search
document.addEventListener('DOMContentLoaded', function() {
    // Create toast container
    createToastContainer();

    // Add enter key support for search inputs
    const searchInput = document.getElementById('searchInput');
    const skillsFilter = document.getElementById('skillsFilter');

    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }

    if (skillsFilter) {
        skillsFilter.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
});
</script>
{% endblock %}
