{% extends 'base.html.twig' %}

{% block title %}Candidate Dashboard - HireFlow{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
<style>
    .stat-card {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card.pending { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.accepted { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card.rejected { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: white;
        margin: 0;
    }
    .stat-label {
        color: rgba(255,255,255,0.9);
        font-size: 1rem;
        margin: 0;
    }

    .status-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-accepted { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #495057;
    }

    .btn-view {
        background: #6c757d;
        color: white;
        padding: 5px 15px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.85rem;
    }
    .btn-view:hover {
        background: #5a6268;
        color: white;
        text-decoration: none;
    }

    .btn-apply {
        background: #007bff;
        color: white;
        padding: 10px 25px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 600;
    }
    .btn-apply:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
    }

    /* Chart container styles */
    .chart-container {
        position: relative;
        height: 250px;
        width: 100%;
        margin: 0 auto;
    }

    .chart-legend {
        list-style: none;
        padding: 0;
        margin: 20px 0 0 0;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
    }

    .chart-legend-item {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 6px;
        display: inline-block;
    }

    .no-data-chart {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: #6c757d;
    }

    .no-data-chart i {
        font-size: 3rem;
        margin-bottom: 10px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Welcome back, {{ app.user.fullName }} </h1>
            <p class="text-muted mb-0">Track your job applications and discover new opportunities</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ path('offer_index') }}" class="btn btn-primary">
                <i class="bi bi-search me-2"></i>Browse Jobs
            </a>
            <!-- Note: We'll add this link when we create the profile page -->
            <!-- <a href="{{ path('profile_edit') }}" class="btn btn-outline-primary">
                <i class="bi bi-person me-2"></i>Edit Profile
            </a> -->
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-5">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card total h-100">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <p class="stat-label">Total Applications</p>
                        <h2 class="stat-number">{{ stats.total|default(0) }}</h2>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-file-text" style="font-size: 2.5rem; color: rgba(255,255,255,0.8);"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card pending h-100">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <p class="stat-label">Pending Review</p>
                        <h2 class="stat-number">{{ stats.pending|default(0) }}</h2>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-clock" style="font-size: 2.5rem; color: rgba(255,255,255,0.8);"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card accepted h-100">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <p class="stat-label">Accepted</p>
                        <h2 class="stat-number">{{ stats.accepted|default(0) }}</h2>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-check-circle" style="font-size: 2.5rem; color: rgba(255,255,255,0.8);"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card rejected h-100">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <p class="stat-label">Rejected</p>
                        <h2 class="stat-number">{{ stats.rejected|default(0) }}</h2>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-x-circle" style="font-size: 2.5rem; color: rgba(255,255,255,0.8);"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Two Columns Layout -->
    <div class="row">
        <!-- Recent Applications -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Applications</h5>
                        {% if applications|length > 0 %}
                        <span class="badge bg-primary">{{ applications|length }} total</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if applications|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Position</th>
                                        <th>Company</th>
                                        <th>Applied Date</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for application in applications|slice(0, 5) %}
                                    <tr>
                                        <td>
                                            <div class="fw-semibold">{{ application.offer.title }}</div>
                                            <small class="text-muted">{{ application.offer.skills|split(',')|slice(0, 2)|join(', ') }}</small>
                                        </td>
                                        <td>{{ application.offer.recruiter.fullName }}</td>
                                        <td>{{ application.createdAt|date('M d, Y') }}</td>
                                        <td>
                                            <span class="status-badge status-{{ application.status|lower }}">
                                                {{ application.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <a href="#" class="btn-view">View Details</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if applications|length > 5 %}
                            <div class="text-center mt-3">
                                <a href="#" class="btn btn-outline-primary btn-sm">View All Applications</a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-file-text" style="font-size: 4rem; color: #dee2e6;"></i>
                            </div>
                            <h5 class="text-muted mb-3">No applications yet</h5>
                            <p class="text-muted mb-4">Start your job search and apply to positions that match your skills</p>
                            <a href="{{ path('offer_index') }}" class="btn btn-primary btn-lg">
                                <i class="bi bi-search me-2"></i>Browse Available Jobs
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Application Status Chart -->
        <div class="col-lg-4 mb-4">
            <!-- Application Status Chart -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Application Status Distribution</h5>
                </div>
                <div class="card-body">
                    {% if stats.total > 0 %}
                        <div class="chart-container">
                            <canvas id="applicationStatusChart"></canvas>
                        </div>
                        <ul class="chart-legend" id="chartLegend">
                            <!-- Legend will be populated by JavaScript -->
                        </ul>
                    {% else %}
                        <div class="no-data-chart">
                            <i class="bi bi-pie-chart"></i>
                            <p class="text-muted">No application data available</p>
                            <small>Apply to jobs to see status distribution</small>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="card shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Job Search Tips</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex mb-3">
                        <div class="flex-shrink-0">
                            <i class="bi bi-check-circle-fill text-success"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <small class="text-muted">Customize your resume for each application to highlight relevant skills.</small>
                        </div>
                    </div>
                    <div class="d-flex mb-3">
                        <div class="flex-shrink-0">
                            <i class="bi bi-check-circle-fill text-success"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <small class="text-muted">Follow up after 5-7 business days if you haven't heard back.</small>
                        </div>
                    </div>
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-check-circle-fill text-success"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <small class="text-muted">Prepare for interviews by researching the company and practicing common questions.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts_body %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Candidate dashboard loaded');

    // Only initialize chart if we have data
    const stats = {
        total: {{ stats.total|default(0) }},
        pending: {{ stats.pending|default(0) }},
        accepted: {{ stats.accepted|default(0) }},
        rejected: {{ stats.rejected|default(0) }}
    };

    if (stats.total > 0) {
        initializeApplicationChart(stats);
    }

    // Function to initialize the application status chart
    function initializeApplicationChart(stats) {
        const ctx = document.getElementById('applicationStatusChart').getContext('2d');
        const legendContainer = document.getElementById('chartLegend');

        // Define colors for each status
        const colorPalette = {
            pending: 'rgba(255, 193, 7, 0.8)',
            accepted: 'rgba(40, 167, 69, 0.8)',
            rejected: 'rgba(220, 53, 69, 0.8)'
        };

        // Border colors (slightly darker)
        const borderColors = {
            pending: 'rgb(255, 193, 7)',
            accepted: 'rgb(40, 167, 69)',
            rejected: 'rgb(220, 53, 69)'
        };

        // Prepare data
        const labels = [];
        const data = [];
        const backgroundColors = [];
        const borderColorArray = [];

        // Add data only if count > 0
        if (stats.pending > 0) {
            labels.push('Pending');
            data.push(stats.pending);
            backgroundColors.push(colorPalette.pending);
            borderColorArray.push(borderColors.pending);
        }

        if (stats.accepted > 0) {
            labels.push('Accepted');
            data.push(stats.accepted);
            backgroundColors.push(colorPalette.accepted);
            borderColorArray.push(borderColors.accepted);
        }

        if (stats.rejected > 0) {
            labels.push('Rejected');
            data.push(stats.rejected);
            backgroundColors.push(colorPalette.rejected);
            borderColorArray.push(borderColors.rejected);
        }

        // Create chart
        const chart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColorArray,
                    borderWidth: 1,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // We'll create custom legend
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 1000
                }
            }
        });

        // Create custom legend
        if (legendContainer) {
            legendContainer.innerHTML = '';

            labels.forEach((label, index) => {
                const li = document.createElement('li');
                li.className = 'chart-legend-item';

                const colorSpan = document.createElement('span');
                colorSpan.className = 'legend-color';
                colorSpan.style.backgroundColor = backgroundColors[index];

                const textSpan = document.createElement('span');
                const percentage = Math.round((data[index] / stats.total) * 100);
                textSpan.textContent = `${label}: ${data[index]} (${percentage}%)`;

                li.appendChild(colorSpan);
                li.appendChild(textSpan);
                legendContainer.appendChild(li);
            });
        }

        // Add resize event listener to handle chart resizing
        window.addEventListener('resize', function() {
            chart.resize();
        });

        return chart;
    }

    // Optional: Add animation to stat cards on scroll
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    // Animate stat cards
    document.querySelectorAll('.stat-card').forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        observer.observe(card);
    });

    // Add click event for view details buttons (placeholder for now)
    document.querySelectorAll('.btn-view').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            // This will be implemented when we add application detail modals
            console.log('View details clicked - to be implemented');
        });
    });
});
</script>
{% endblock %}
